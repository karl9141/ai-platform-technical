# 模块 B：告警邮件智能分析

## 1. 模块概述

自动解析告警邮件，分类告警类型，匹配历史案例，生成处理建议和客户回复模板。

### 1.1 核心原则

- ✅ 自动分析，人工确认回复
- ✅ 知识库持续沉淀
- ✅ 多渠道通知

## 2. 处理流程

```
┌─────────────────────────────────────────────────────────────────┐
│                      告警邮件分析流程                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────┐                                                    │
│  │  告警   │ 监控系统发送的告警邮件                              │
│  │  邮件   │                                                    │
│  └────┬────┘                                                    │
│       │                                                          │
│       ▼                                                          │
│  ┌─────────────────────────────────────────┐                    │
│  │            N8N IMAP 接收                 │                    │
│  │  - 接收告警邮件                          │                    │
│  │  - 解析邮件内容                          │                    │
│  └────────────────┬────────────────────────┘                    │
│                   │                                              │
│                   ▼                                              │
│  ┌─────────────────────────────────────────┐                    │
│  │            Dify AI 分析                  │                    │
│  │  - 告警分类                              │                    │
│  │  - 知识库匹配                            │                    │
│  │  - 生成处理建议                          │                    │
│  │  - 生成回复模板                          │                    │
│  └────────────────┬────────────────────────┘                    │
│                   │                                              │
│       ┌───────────┼───────────┬───────────┐                     │
│       ▼           ▼           ▼           ▼                     │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐               │
│  │  Lark   │ │  Jira   │ │  邮件   │ │  知识库  │               │
│  │  通知   │ │  工单   │ │  模板   │ │  更新   │               │
│  └─────────┘ └─────────┘ └─────────┘ └─────────┘               │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## 3. 告警分类

### 3.1 分类规则

| 类别 | 识别特征 | 默认优先级 | 响应时间 |
|------|----------|------------|----------|
| CPU | cpu usage, load average, processor | P2 | 30 分钟 |
| Memory | memory, OOM, heap, OutOfMemory | P2 | 30 分钟 |
| Disk | disk space, inode, storage | P3 | 2 小时 |
| Network | connection timeout, network unreachable | P1 | 15 分钟 |
| Application | exception, error, crash, 500 | P1 | 15 分钟 |
| Database | connection failed, slow query, deadlock | P1 | 15 分钟 |
| Security | unauthorized, attack, breach | P0 | 5 分钟 |

### 3.2 优先级定义

| 优先级 | 说明 | 响应 SLA | 通知方式 |
|--------|------|----------|----------|
| P0 | 紧急 | 5 分钟 | Lark @所有人 + 电话 |
| P1 | 高 | 15 分钟 | Lark @值班 |
| P2 | 中 | 30 分钟 | Lark 群通知 |
| P3 | 低 | 2 小时 | Lark 群通知 |

## 4. AI 分析设计

### 4.1 Prompt 模板

```
你是一个运维告警分析助手。分析以下告警邮件，提取关键信息并给出处理建议。

请以 JSON 格式返回：
- alert_type: string (告警类型：CPU/Memory/Disk/Network/Application/Database/Security/Other)
- priority: string (优先级：P0/P1/P2/P3)
- summary: string (告警摘要，一句话描述)
- affected_system: string (受影响系统)
- root_cause_guess: string (可能的根本原因)
- suggested_actions: array (建议操作步骤)
- is_known_issue: boolean (是否为已知问题)
- email_template: string (客户回复邮件模板)

告警邮件内容：
---
主题：{subject}
发送时间：{timestamp}
正文：
{body}
---

历史相似案例（供参考）：
{similar_cases}
```

### 4.2 输出示例

```json
{
  "alert_type": "Application",
  "priority": "P1",
  "summary": "prod-payment 服务异常，错误率升高至 15%",
  "affected_system": "prod-payment-01",
  "root_cause_guess": "上游支付网关响应超时导致",
  "suggested_actions": [
    "检查服务日志确认异常原因",
    "检查上游支付网关状态",
    "若网关正常，重启服务"
  ],
  "is_known_issue": true,
  "similar_case_id": "ALERT-2024-001",
  "email_template": "尊敬的客户，\n\n我们已收到关于支付服务的告警通知..."
}
```

## 5. 知识库设计

### 5.1 知识条目结构

```json
{
  "id": "KB-001",
  "title": "支付服务错误率升高",
  "alert_type": "Application",
  "symptoms": ["错误率升高", "响应超时", "5xx 增加"],
  "root_causes": ["上游网关超时", "数据库连接池满", "内存不足"],
  "solutions": [
    {"step": 1, "action": "检查上游网关状态"},
    {"step": 2, "action": "检查数据库连接池"},
    {"step": 3, "action": "重启服务"}
  ],
  "prevention": "增加网关超时监控，配置连接池告警",
  "related_cases": ["ALERT-2024-001", "ALERT-2024-015"],
  "last_updated": "2026-01-15"
}
```

### 5.2 RAG 检索流程

```
告警内容 → 向量化 → 相似度检索 → Top 3 案例 → 合并上下文 → LLM 分析
```

## 6. 多渠道分发

### 6.1 Lark 通知

```
┌─────────────────────────────────────────┐
│ 🚨 告警通知                             │
├─────────────────────────────────────────┤
│ 类型：Application                        │
│ 优先级：P1 🔴                            │
│ 系统：prod-payment-01                    │
├─────────────────────────────────────────┤
│ 摘要：                                   │
│ 支付服务错误率升高至 15%                  │
├─────────────────────────────────────────┤
│ 建议操作：                               │
│ 1. 检查服务日志                          │
│ 2. 检查上游网关状态                       │
│ 3. 必要时重启服务                        │
├─────────────────────────────────────────┤
│ 📚 相似案例：ALERT-2024-001 (89% 匹配)   │
├─────────────────────────────────────────┤
│ [📋 创建工单] [📧 生成回复] [✅ 已处理]  │
└─────────────────────────────────────────┘
```

### 6.2 Jira 工单

自动创建或关联现有工单：

| 字段 | 内容 |
|------|------|
| Summary | [ALERT-P1] prod-payment 服务异常 |
| Priority | Highest |
| Description | 告警详情 + AI 分析 + 建议 |
| Labels | alert, ai-analyzed, P1 |

### 6.3 邮件回复模板

```
尊敬的客户，

我们已收到关于 [系统名称] 的告警通知，现将处理情况说明如下：

【告警概述】
[AI 生成的摘要]

【影响范围】
[受影响的服务/功能]

【处理进展】
- [时间] [操作]
- [时间] [操作]

【预计恢复时间】
[时间/待定]

如有问题，请随时联系。

此致
运维团队
```

## 7. 知识库更新

### 7.1 更新触发

- 告警关闭时触发
- 运维人员手动触发

### 7.2 更新内容

```json
{
  "alert_id": "ALERT-2026-001",
  "resolution": "重启服务后恢复",
  "root_cause_confirmed": "上游网关超时",
  "time_to_resolve": "15分钟",
  "handled_by": "张三",
  "lessons_learned": "需增加网关超时告警"
}
```

## 8. 配置项

| 配置 | 说明 | 默认值 |
|------|------|--------|
| IMAP_SERVER | 邮件服务器 | - |
| IMAP_USER | 邮箱账号 | - |
| IMAP_FOLDER | 监控文件夹 | INBOX |
| P0_NOTIFY_ALL | P0 是否 @所有人 | true |
| AUTO_CREATE_JIRA | 自动创建工单 | false |
| RAG_TOP_K | 检索案例数 | 3 |
