# 系统架构设计

## 1. 架构概述

本平台采用分层架构设计，实现事件驱动的 AI 辅助决策系统。

## 2. 架构图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           团队 AI 辅助平台                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │                        事件入口层                                 │   │
│  │  ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐       │   │
│  │  │  Lark   │    │  Email  │    │  Jira   │    │   Web   │       │   │
│  │  │ Webhook │    │  IMAP   │    │ Webhook │    │   UI    │       │   │
│  │  └────┬────┘    └────┬────┘    └────┬────┘    └────┬────┘       │   │
│  └───────┼──────────────┼──────────────┼──────────────┼─────────────┘   │
│          │              │              │              │                 │
│          └──────────────┴──────────────┴──────────────┘                 │
│                                   │                                     │
│                                   ▼                                     │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │                       工作流编排层 (N8N)                          │   │
│  │                                                                   │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐           │   │
│  │  │ 任务收集流程  │  │ 告警处理流程  │  │ 健康度评估   │           │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘           │   │
│  └──────────────────────────────────────────────────────────────────┘   │
│                                   │                                     │
│                                   ▼                                     │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │                        AI 能力层 (Dify)                           │   │
│  │                                                                   │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐           │   │
│  │  │  任务分析器   │  │  告警分析器   │  │  知识库(RAG) │           │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘           │   │
│  └──────────────────────────────────────────────────────────────────┘   │
│                                   │                                     │
│                    ┌──────────────┼──────────────┐                     │
│                    ▼              ▼              ▼                     │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐       │
│  │   OpenAI   │  │   Ollama   │  │ PostgreSQL │  │    Redis   │       │
│  │    API     │  │  (本地LLM) │  │   (数据)   │  │   (缓存)   │       │
│  └────────────┘  └────────────┘  └────────────┘  └────────────┘       │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

## 3. 分层说明

### 3.1 事件入口层

| 组件 | 协议 | 职责 |
|------|------|------|
| Lark Webhook | HTTPS | 接收群消息、交互卡片回调 |
| Email IMAP | IMAP/SMTP | 接收告警邮件、发送回复 |
| Jira Webhook | HTTPS | 状态变更通知 |
| Web UI | HTTPS | 管理界面、手动触发 |

### 3.2 工作流编排层 (N8N)

- **核心能力**：流程编排、事件路由、条件判断、集成调用
- **工作流**：
  - 任务收集流程：Lark → AI 分析 → 确认 → Jira
  - 告警处理流程：Email → AI 分析 → 多渠道分发
  - 健康度评估流程：定时 → 数据采集 → 评估 → 报告

### 3.3 AI 能力层 (Dify)

- **LLM 应用**：任务分析器、告警分析器
- **RAG 知识库**：告警历史案例、处理方案
- **模型支持**：OpenAI、Ollama (本地)

### 3.4 基础设施层

| 组件 | 用途 |
|------|------|
| PostgreSQL | 共享数据库（N8N、Dify） |
| Redis | 会话缓存、限流 |
| 向量数据库 | 知识库存储（Dify 内置） |

## 4. 技术选型

### 4.1 核心组件

| 类别 | 选型 | 版本 | 选型理由 |
|------|------|------|----------|
| 工作流引擎 | N8N | latest | 开源、可视化、400+ 集成 |
| AI 应用平台 | Dify | latest | 开源、RAG 内置、多模型 |
| LLM (初期) | OpenAI GPT-4o-mini | - | 效果好、成本低 |
| LLM (后期) | Ollama + Qwen2.5 | - | 本地部署、数据安全 |
| 数据库 | PostgreSQL | 16 | 稳定、兼容性好 |

### 4.2 选型对比

| 候选方案 | 优势 | 劣势 | 决策 |
|----------|------|------|------|
| N8N vs Zapier | 开源、可自托管 | 集成略少 | ✅ N8N |
| Dify vs LangChain | 开箱即用、可视化 | 定制略弱 | ✅ Dify |
| PostgreSQL vs MySQL | 兼容性更好 | - | ✅ PostgreSQL |

## 5. 数据流

### 5.1 运维任务数据流

```
Lark 消息 → N8N 接收 → Dify 分析 → N8N 推送确认 → Leader 确认 → N8N 创建 Jira
                                                          ↓
                                                   PostgreSQL (审计日志)
```

### 5.2 告警处理数据流

```
告警邮件 → N8N 解析 → Dify 分析(+知识库) → N8N 分发 → Lark / Jira / 邮件
                              ↓                              ↓
                        知识库更新 ←───────────────── 告警关闭
```

## 6. 扩展性设计

### 6.1 模型扩展

```
当前：OpenAI API
  ↓ (后期)
本地：Ollama + Qwen2.5 / Llama
```

### 6.2 功能扩展

```
Phase 1: 任务收集
Phase 2: 告警分析
Phase 3: 知识库
Phase 4: 健康度评估
Phase N: 代码 Review、会议纪要...
```

## 7. 部署架构

### 7.1 开发环境 (Docker Compose)

```
单机部署：N8N + Dify + PostgreSQL + Redis
```

### 7.2 生产环境 (Kubernetes)

```
AWS EKS：高可用、弹性扩展
RDS：托管数据库
ALB：负载均衡
```
