# =============================================================================
# AI Platform - 全量服务 Docker Compose
# =============================================================================
# 版本: 4.0 - 服务化架构
#
# 包含服务:
#   - PostgreSQL 15 (共享数据库)
#   - Redis 6 (共享缓存)
#   - Weaviate 1.19 (向量数据库)
#   - Dify 1.12.0 (API + Worker + Web + Plugin Daemon + Sandbox)
#   - N8N 2.7.1 (工作流引擎)
#   - Nginx 1.28 (反向代理)
#   - SSRF Proxy (安全代理)
#
# 使用方法:
#   docker compose up -d
# =============================================================================

# 共享环境变量锚点
x-shared-env: &shared-api-worker-env
  LOG_LEVEL: ${LOG_LEVEL:-INFO}
  SECRET_KEY: ${SECRET_KEY:-sk-9f73s3ljTXVcMT3Blb3ljTqtsKiGHXVcMT3BlbkFJLK7U}
  DEPLOY_ENV: ${DEPLOY_ENV:-PRODUCTION}
  MIGRATION_ENABLED: 'true'

  # Database
  DB_TYPE: postgresql
  DB_USERNAME: ${POSTGRES_USER:-postgres}
  DB_PASSWORD: ${POSTGRES_PASSWORD:-AIPlatform2026}
  DB_HOST: postgres
  DB_PORT: 5432
  DB_DATABASE: ${DIFY_DB_NAME:-dify}

  # Redis
  REDIS_HOST: redis
  REDIS_PORT: 6379
  REDIS_PASSWORD: ${REDIS_PASSWORD:-Redis2026}
  REDIS_DB: 0
  CELERY_BROKER_URL: redis://:${REDIS_PASSWORD:-Redis2026}@redis:6379/1

  # Storage
  STORAGE_TYPE: ${STORAGE_TYPE:-opendal}
  OPENDAL_SCHEME: ${OPENDAL_SCHEME:-fs}
  OPENDAL_FS_ROOT: ${OPENDAL_FS_ROOT:-storage}

  # Vector Store
  VECTOR_STORE: ${VECTOR_STORE:-weaviate}
  WEAVIATE_ENDPOINT: http://weaviate:8080

  # Plugin Daemon
  PLUGIN_DAEMON_URL: http://plugin_daemon:5002
  PLUGIN_DAEMON_KEY: ${PLUGIN_DAEMON_KEY:-lYkiYYT6owG+71oLerGzA7GXCgOT++6ovaezWAjpCjf+Sjc3ZtU+qUEi}

  # Sandbox
  CODE_EXECUTION_ENDPOINT: http://sandbox:8194
  CODE_EXECUTION_API_KEY: ${SANDBOX_API_KEY:-dify-sandbox}

  # URL Configuration
  CONSOLE_WEB_URL: ${CONSOLE_WEB_URL:-}
  CONSOLE_API_URL: ${CONSOLE_API_URL:-}
  APP_WEB_URL: ${APP_WEB_URL:-}
  APP_API_URL: ${APP_API_URL:-}
  SERVICE_API_URL: ${SERVICE_API_URL:-}
  FILES_URL: ${FILES_URL:-}

services:
  # ===========================================================================
  # 共享基础设施
  # ===========================================================================

  postgres:
    image: postgres:15-alpine
    container_name: ai-platform-postgres
    hostname: postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-AIPlatform2026}
      POSTGRES_DB: ${POSTGRES_DB:-postgres}
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./shared/postgres/init-scripts:/docker-entrypoint-initdb.d:ro
    ports:
      - "5432:5432"
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - ai-platform-network

  redis:
    image: redis:6-alpine
    container_name: ai-platform-redis
    hostname: redis
    restart: unless-stopped
    command: redis-server --requirepass ${REDIS_PASSWORD:-Redis2026} --appendonly yes
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"
    healthcheck:
      test: [ "CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-Redis2026}", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - ai-platform-network

  weaviate:
    image: semitechnologies/weaviate:1.19.0
    container_name: ai-platform-weaviate
    hostname: weaviate
    restart: unless-stopped
    environment:
      QUERY_DEFAULTS_LIMIT: 25
      AUTHENTICATION_ANONYMOUS_ACCESS_ENABLED: 'true'
      PERSISTENCE_DATA_PATH: '/var/lib/weaviate'
      DEFAULT_VECTORIZER_MODULE: 'none'
      CLUSTER_HOSTNAME: 'weaviate'
    volumes:
      - weaviate_data:/var/lib/weaviate
    ports:
      - "8080:8080"
    healthcheck:
      test: [ "CMD", "wget", "--spider", "-q", "http://localhost:8080/v1/.well-known/ready" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - ai-platform-network

  # ===========================================================================
  # Dify 服务组
  # ===========================================================================

  dify-api:
    image: langgenius/dify-api:1.12.0
    container_name: ai-platform-dify-api
    hostname: dify-api
    restart: unless-stopped
    environment:
      <<: *shared-api-worker-env
      MODE: api
      DIFY_BIND_ADDRESS: 0.0.0.0
      DIFY_PORT: 5001
      SERVER_WORKER_AMOUNT: 1
      GUNICORN_TIMEOUT: 360
      CONSOLE_CORS_ALLOW_ORIGINS: ${CONSOLE_CORS_ALLOW_ORIGINS:-*}
      WEB_API_CORS_ALLOW_ORIGINS: ${WEB_API_CORS_ALLOW_ORIGINS:-*}
    volumes:
      - dify_storage:/app/api/storage
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:5001/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      weaviate:
        condition: service_healthy
    networks:
      - ai-platform-network
      - ssrf_proxy_network

  dify-worker:
    image: langgenius/dify-api:1.12.0
    container_name: ai-platform-dify-worker
    hostname: dify-worker
    restart: unless-stopped
    environment:
      <<: *shared-api-worker-env
      MODE: worker
    volumes:
      - dify_storage:/app/api/storage
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - ai-platform-network
      - ssrf_proxy_network

  dify-worker-beat:
    image: langgenius/dify-api:1.12.0
    container_name: ai-platform-dify-worker-beat
    hostname: dify-worker-beat
    restart: unless-stopped
    environment:
      <<: *shared-api-worker-env
      MODE: beat
    volumes:
      - dify_storage:/app/api/storage
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - ai-platform-network

  dify-web:
    image: langgenius/dify-web:1.12.0
    container_name: ai-platform-dify-web
    hostname: dify-web
    restart: unless-stopped
    environment:
      CONSOLE_API_URL: ${CONSOLE_API_URL:-}
      APP_API_URL: ${APP_API_URL:-}
      MARKETPLACE_API_URL: ${MARKETPLACE_API_URL:-https://marketplace.dify.ai}
      MARKETPLACE_URL: ${MARKETPLACE_URL:-https://marketplace.dify.ai}
    healthcheck:
      test: [ "CMD", "wget", "--spider", "-q", "http://localhost:3000" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - ai-platform-network

  plugin_daemon:
    image: langgenius/dify-plugin-daemon:0.5.3-local
    container_name: ai-platform-plugin-daemon
    hostname: plugin_daemon
    restart: unless-stopped
    environment:
      <<: *shared-api-worker-env
      DB_DATABASE: ${DIFY_PLUGIN_DB_NAME:-dify_plugin}
      SERVER_PORT: 5002
      SERVER_KEY: ${PLUGIN_DAEMON_KEY:-lYkiYYT6owG+71oLerGzA7GXCgOT++6ovaezWAjpCjf+Sjc3ZtU+qUEi}
      DIFY_INNER_API_URL: http://dify-api:5001
      DIFY_INNER_API_KEY: ${PLUGIN_DIFY_INNER_API_KEY:-QaHbTe77CtuXmsfyhR7+vRjI/+XbV1AaFy691iy+kGDv2Jvy0/eAh8Y1}
      PLUGIN_REMOTE_INSTALLING_HOST: 0.0.0.0
      PLUGIN_REMOTE_INSTALLING_PORT: 5003
      PLUGIN_WORKING_PATH: /app/storage/cwd
      FORCE_VERIFYING_SIGNATURE: 'true'
      PLUGIN_STORAGE_TYPE: local
      PLUGIN_STORAGE_LOCAL_ROOT: /app/storage
    volumes:
      - dify_plugin_storage:/app/storage
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - ai-platform-network

  sandbox:
    image: langgenius/dify-sandbox:0.2.12
    container_name: ai-platform-sandbox
    hostname: sandbox
    restart: unless-stopped
    environment:
      API_KEY: ${SANDBOX_API_KEY:-dify-sandbox}
      GIN_MODE: release
      WORKER_TIMEOUT: 15
      ENABLE_NETWORK: 'true'
      HTTP_PROXY: http://ssrf_proxy:3128
      HTTPS_PROXY: http://ssrf_proxy:3128
      SANDBOX_PORT: 8194
    volumes:
      - sandbox_dependencies:/dependencies
      - sandbox_conf:/conf
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8194/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - ssrf_proxy_network

  ssrf_proxy:
    image: ubuntu/squid:latest
    container_name: ai-platform-ssrf-proxy
    hostname: ssrf_proxy
    restart: unless-stopped
    volumes:
      - ./dify/ssrf_proxy/squid.conf:/etc/squid/squid.conf:ro
      - ssrf_proxy_cache:/var/spool/squid
    networks:
      - ssrf_proxy_network
      - ai-platform-network

  # ===========================================================================
  # N8N 服务
  # ===========================================================================

  n8n:
    image: docker.n8n.io/n8nio/n8n:2.7.1
    container_name: ai-platform-n8n
    hostname: n8n
    restart: unless-stopped
    environment:
      DB_TYPE: postgresdb
      DB_POSTGRESDB_HOST: postgres
      DB_POSTGRESDB_PORT: 5432
      DB_POSTGRESDB_DATABASE: ${N8N_DB_NAME:-n8n}
      DB_POSTGRESDB_USER: ${POSTGRES_USER:-postgres}
      DB_POSTGRESDB_PASSWORD: ${POSTGRES_PASSWORD:-AIPlatform2026}
      N8N_HOST: ${N8N_HOST:-localhost}
      N8N_PORT: ${N8N_PORT:-5678}
      N8N_PROTOCOL: ${N8N_PROTOCOL:-http}
      N8N_ENCRYPTION_KEY: ${N8N_ENCRYPTION_KEY:-your-32-char-encryption-key}
      WEBHOOK_URL: ${WEBHOOK_URL:-http://localhost:5678/}
      TZ: ${TZ:-Asia/Tokyo}
    volumes:
      - n8n_data:/home/node/.n8n
    healthcheck:
      test: [ "CMD", "wget", "--spider", "-q", "http://localhost:5678/healthz" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - ai-platform-network

  # ===========================================================================
  # Nginx 反向代理
  # ===========================================================================

  nginx:
    image: nginx:1.28.1-alpine
    container_name: ai-platform-nginx
    hostname: nginx
    restart: unless-stopped
    volumes:
      - ./shared/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./shared/nginx/conf.d:/etc/nginx/conf.d:ro
    ports:
      - "443:443"
      - "3000:3000"
      - "5678:5678"
    healthcheck:
      test: [ "CMD", "nginx", "-t" ]
      interval: 30s
      timeout: 10s
      retries: 3
    depends_on:
      - n8n
      - dify-api
      - dify-web
    networks:
      - ai-platform-network

# =============================================================================
# 数据卷
# =============================================================================
volumes:
  postgres_data:
    name: ai-platform-postgres-data
  redis_data:
    name: ai-platform-redis-data
  weaviate_data:
    name: ai-platform-weaviate-data
  dify_storage:
    name: ai-platform-dify-storage
  dify_plugin_storage:
    name: ai-platform-dify-plugin-storage
  sandbox_dependencies:
    name: ai-platform-sandbox-dependencies
  sandbox_conf:
    name: ai-platform-sandbox-conf
  ssrf_proxy_cache:
    name: ai-platform-ssrf-proxy-cache
  n8n_data:
    name: ai-platform-n8n-data

# =============================================================================
# 网络
# =============================================================================
networks:
  ai-platform-network:
    name: ai-platform-network
    driver: bridge
  ssrf_proxy_network:
    name: ssrf_proxy_network
    internal: true
