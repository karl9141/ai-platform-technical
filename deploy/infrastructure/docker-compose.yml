# =============================================================================
# AI Platform - All-in-One Deployment
# =============================================================================
#
# 一键部署完整的 AI 辅助平台：N8N + Dify + 数据库
#
# 使用方法：
#   1. 配置 .env 文件（可选）
#   2. 运行: docker-compose up -d
#   3. 访问:
#      - N8N: http://localhost:5678
#      - Dify: http://localhost:3000
#
# =============================================================================

services:
  # ===========================================================================
  # 共享基础设施
  # ===========================================================================

  # PostgreSQL - 共享数据库
  postgres:
    image: postgres:16-alpine
    container_name: ai-platform-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-ai_platform_2026}
      POSTGRES_DB: postgres
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-db.sql:/docker-entrypoint-initdb.d/init-db.sql:ro
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - ai-platform

  # Redis - 缓存
  redis:
    image: redis:7-alpine
    container_name: ai-platform-redis
    restart: unless-stopped
    command: redis-server --requirepass ${REDIS_PASSWORD:-ai_platform_2026}
    volumes:
      - redis_data:/data
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - ai-platform

  # ===========================================================================
  # N8N - 工作流引擎
  # ===========================================================================

  n8n:
    image: docker.n8n.io/n8nio/n8n:latest
    container_name: ai-platform-n8n
    restart: unless-stopped
    ports:
      - "5678:5678"
    environment:
      # 数据库
      DB_TYPE: postgresdb
      DB_POSTGRESDB_HOST: postgres
      DB_POSTGRESDB_PORT: 5432
      DB_POSTGRESDB_DATABASE: n8n
      DB_POSTGRESDB_USER: ${POSTGRES_USER:-postgres}
      DB_POSTGRESDB_PASSWORD: ${POSTGRES_PASSWORD:-ai_platform_2026}
      # N8N 配置
      N8N_HOST: ${N8N_HOST:-localhost}
      N8N_PORT: 5678
      N8N_PROTOCOL: http
      WEBHOOK_URL: ${N8N_WEBHOOK_URL:-http://localhost:5678/}
      # 时区
      GENERIC_TIMEZONE: ${TIMEZONE:-Asia/Tokyo}
      TZ: ${TIMEZONE:-Asia/Tokyo}
    volumes:
      - n8n_data:/home/node/.n8n
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - ai-platform

  # ===========================================================================
  # Dify - AI 应用平台
  # ===========================================================================

  # Dify API
  dify-api:
    image: langgenius/dify-api:latest
    container_name: ai-platform-dify-api
    restart: unless-stopped
    environment:
      MODE: api
      SECRET_KEY: ${DIFY_SECRET_KEY:-sk-9f73s3ljTXVcMT3Blb3ljTqtsKiGHXVcMT3BlbkFJ}
      # 数据库
      DB_USERNAME: ${POSTGRES_USER:-postgres}
      DB_PASSWORD: ${POSTGRES_PASSWORD:-ai_platform_2026}
      DB_HOST: postgres
      DB_PORT: 5432
      DB_DATABASE: dify
      # Redis
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-ai_platform_2026}
      # 存储
      STORAGE_TYPE: local
      STORAGE_LOCAL_PATH: /app/api/storage
      # 向量数据库
      VECTOR_STORE: weaviate
      WEAVIATE_ENDPOINT: http://weaviate:8080
      # 日志
      LOG_LEVEL: INFO
    volumes:
      - dify_storage:/app/api/storage
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - ai-platform

  # Dify Worker
  dify-worker:
    image: langgenius/dify-api:latest
    container_name: ai-platform-dify-worker
    restart: unless-stopped
    environment:
      MODE: worker
      SECRET_KEY: ${DIFY_SECRET_KEY:-sk-9f73s3ljTXVcMT3Blb3ljTqtsKiGHXVcMT3BlbkFJ}
      DB_USERNAME: ${POSTGRES_USER:-postgres}
      DB_PASSWORD: ${POSTGRES_PASSWORD:-ai_platform_2026}
      DB_HOST: postgres
      DB_PORT: 5432
      DB_DATABASE: dify
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-ai_platform_2026}
      STORAGE_TYPE: local
      STORAGE_LOCAL_PATH: /app/api/storage
      VECTOR_STORE: weaviate
      WEAVIATE_ENDPOINT: http://weaviate:8080
    volumes:
      - dify_storage:/app/api/storage
    depends_on:
      - dify-api
    networks:
      - ai-platform

  # Dify Web
  dify-web:
    image: langgenius/dify-web:latest
    container_name: ai-platform-dify-web
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      CONSOLE_API_URL: ""
      APP_API_URL: ""
    depends_on:
      - dify-api
    networks:
      - ai-platform

  # Weaviate 向量数据库
  weaviate:
    image: semitechnologies/weaviate:1.19.0
    container_name: ai-platform-weaviate
    restart: unless-stopped
    environment:
      QUERY_DEFAULTS_LIMIT: 25
      AUTHENTICATION_ANONYMOUS_ACCESS_ENABLED: 'true'
      PERSISTENCE_DATA_PATH: '/var/lib/weaviate'
      DEFAULT_VECTORIZER_MODULE: 'none'
    volumes:
      - weaviate_data:/var/lib/weaviate
    networks:
      - ai-platform

  # Nginx 反向代理
  nginx:
    image: nginx:alpine
    container_name: ai-platform-nginx
    restart: unless-stopped
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - n8n
      - dify-api
      - dify-web
    networks:
      - ai-platform

# =============================================================================
# Volumes
# =============================================================================
volumes:
  postgres_data:
    name: ai_platform_postgres
  redis_data:
    name: ai_platform_redis
  n8n_data:
    name: ai_platform_n8n
  dify_storage:
    name: ai_platform_dify_storage
  weaviate_data:
    name: ai_platform_weaviate

# =============================================================================
# Networks
# =============================================================================
networks:
  ai-platform:
    name: ai-platform
    driver: bridge
